<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Audio Engine Test</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      h1 {
        color: #333;
        border-bottom: 2px solid #ddd;
        padding-bottom: 10px;
      }
      button {
        background-color: #4caf50;
        border: none;
        color: white;
        padding: 10px 20px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin: 10px 2px;
        cursor: pointer;
        border-radius: 4px;
      }
      button:hover {
        background-color: #45a049;
      }
      #console {
        background-color: #333;
        color: #fff;
        padding: 10px;
        border-radius: 4px;
        height: 300px;
        overflow-y: auto;
        font-family: monospace;
        margin-top: 20px;
      }
      .log {
        margin: 5px 0;
        border-bottom: 1px solid #444;
        padding-bottom: 5px;
      }
      .error {
        color: #ff6b6b;
      }
      .success {
        color: #69db7c;
      }
      .info {
        color: #74c0fc;
      }
    </style>
  </head>
  <body>
    <h1>Buchla-inspired Audio Engine Test</h1>
    <div>
      <button id="startTest">Start Audio Test</button>
      <button id="stopTest">Stop Audio</button>
      <button id="clearConsole">Clear Console</button>
    </div>
    <div id="console"></div>

    <script type="module">
      import audioEngine from "./src/services/AudioEngine.js";

      // Console output redirection
      const consoleElement = document.getElementById("console");

      // Override console.log
      const originalLog = console.log;
      console.log = function (...args) {
        originalLog.apply(console, args);
        const message = args
          .map((arg) => (typeof arg === "object" ? JSON.stringify(arg) : arg))
          .join(" ");
        const logElement = document.createElement("div");
        logElement.className = "log";
        logElement.textContent = message;
        consoleElement.appendChild(logElement);
        consoleElement.scrollTop = consoleElement.scrollHeight;
      };

      // Override console.error
      const originalError = console.error;
      console.error = function (...args) {
        originalError.apply(console, args);
        const message = args
          .map((arg) => (typeof arg === "object" ? JSON.stringify(arg) : arg))
          .join(" ");
        const logElement = document.createElement("div");
        logElement.className = "log error";
        logElement.textContent = "ERROR: " + message;
        consoleElement.appendChild(logElement);
        consoleElement.scrollTop = consoleElement.scrollHeight;
      };

      async function testAudioEngine() {
        console.log("Starting Audio Engine Test...");

        try {
          // Initialize the audio engine
          await audioEngine.initialize();
          console.log("Audio Engine initialized");

          // Test the signal path
          const signalPathTestResult = await audioEngine.testSignalPath();
          console.log(
            "Signal Path Test Result:",
            signalPathTestResult ? "PASSED" : "FAILED"
          );

          // Test setting various parameters
          console.log("Testing parameter controls...");

          // Oscillator parameters
          audioEngine.setOscillatorParams(1, {
            frequency: 220,
            waveType: "sine",
            waveShape: 0.3,
          });
          audioEngine.setOscillatorParams(2, {
            frequency: 330,
            waveType: "triangle",
            waveShape: 0.5,
          });
          audioEngine.setOscillatorParams(3, {
            frequency: 440,
            waveType: "sawtooth",
            waveShape: 0.7,
          });

          // Envelope parameters
          audioEngine.setEnvelope(0, { rise: 0.01, fall: 0.2, level: 0.8 });
          audioEngine.setEnvelope(1, { rise: 0.05, fall: 0.5, level: 0.7 });

          // Matrix mixer settings
          for (let i = 0; i < 4; i++) {
            for (let j = 0; j < 4; j++) {
              // Set crosspoints with varied values
              const level = i === j ? 0.8 : (i + j) % 2 === 0 ? 0.2 : 0;
              audioEngine.setMixerPoint(i, j, level);
            }
          }

          console.log("Test running - listen to the audio output...");
        } catch (error) {
          console.error("Audio Engine Test failed:", error);
        }
      }

      document
        .getElementById("startTest")
        .addEventListener("click", async () => {
          try {
            await testAudioEngine();
          } catch (e) {
            console.error("Error running test:", e);
          }
        });

      document.getElementById("stopTest").addEventListener("click", () => {
        try {
          audioEngine.stopClock();
          audioEngine.stopPlayback();
          console.log("Audio stopped");
        } catch (e) {
          console.error("Error stopping audio:", e);
        }
      });

      document.getElementById("clearConsole").addEventListener("click", () => {
        consoleElement.innerHTML = "";
      });

      console.log(
        'Audio Engine Test page loaded. Click "Start Audio Test" to begin.'
      );
    </script>
  </body>
</html>
